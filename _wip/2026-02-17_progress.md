# 2026-02-17 進捗

## 目的

- Wikipedia『性質』『その他』から抽出する短い引用が、数字ページと無関係な断片になったり、ページ内の別セクションと重複して冗長になる問題を抑止する。
- macOS ローカル環境（Python 3.9 venv）で生成スクリプトが確実に動くようにする。

## 変更点の要約

- Wikipedia セクション引用の候補に「対象の数字（例: `6` / `06` / `006` / `六` / `第六` など）が含まれること」を基本条件としてフィルタし、無関係な引用を採用しにくくした。
- Wikipedia セクション引用の採用件数を `limit`（現状 3 件）に上限固定し、閾値超過で引用が大量に増える挙動を停止（ページの重複・冗長さを抑制）。
- 「科学・技術（例）」で原子番号の元素を既に提示しているため、Wikipedia『その他』側に原子番号系の引用が来た場合はスキップし、重複を回避。
- macOS/Python 3.9 で `Path.write_text(..., newline=...)` が使えず生成が落ちる問題を修正。
- VS Code タスクが venv 等の選択中 Python を使うように修正（PATH の `python` に依存しない）。

## 影響範囲（編集したファイル）

- tools/wikipedia_ja.py
- tools/generate_numbers.py
- .vscode/tasks.json

## 動作確認

- `--wikipedia-sections --refresh-wikipedia-sections --only 6,22,31,57,444` でサンプル再生成
- 内部リンクチェック: `tools/check_internal_links.py`（Missing links: 0）

## 未完了タスク

- 全件（0..999）の再生成を実行し、引用の採用結果が想定どおりかをざっとスポット確認（必要なら pins / overrides で調整）。

## 参考

- 例: numbers/0xx/006.md で無関係引用（数字不在）を除去できることを確認

---

## 追記（全件再生成・仕様更新）

### 目的

- Wikipedia『性質』『その他』の短い引用について、閾値以上なら **3件上限を設けず全件**を扱えるようにする。
- 「現行（上限撤廃）」「旧（最大3件）」の両方の抽出結果を取り込み、ページには **ラベル無しでマージ**して出力する。

### 変更点の要約

- 抽出側で「旧（最大3件）」も同時に計算し、キャッシュに `*_legacy` として保存する。
- 生成側では現行/旧の結果を（ラベル無しで）和集合としてマージし、`Wikipedia（要点）` に出力する。

### 動作確認

- 全件（0..999）再生成を実施（キャッシュ利用のオフライン運用）。
- 内部リンクチェック: `tools/check_internal_links.py`（Scanned markdown files: 1005 / Missing links: 0）

---

## 追記（ドライラン5件の薄化対策）

### 背景

- 6,22,31,57,444 で Wikipedia 引用（特に「その他（要約）」）が減って見える問題の確認。

### 変更点の要約

- `tools/wikipedia_ja.py` の重要度選抜で、閾値以上が少なすぎる場合に「最低件数」まで次点候補で補完するフォールバックを追加（閾値以上は引き続き全件維持）。
  - kind別の最低件数目安: `other` は10、`property` は6（limitがある場合はその範囲内）。
- Wikipedia 冒頭引用で非generic文が見つからない場合でも、先頭文へフォールバックして `first_sentence` が空になりにくいよう補強。

### 動作確認

- `--wikipedia-sections --refresh-wikipedia --refresh-wikipedia-sections --only 6,22,31,57,444` で refresh 付き再生成。
- `git diff --stat HEAD -- numbers/0xx/006.md numbers/0xx/022.md numbers/0xx/031.md numbers/0xx/057.md numbers/4xx/444.md` で差分量を確認（28 insertions / 8 deletions）。

---

## 追記（引用品質の改善・全件再生成）

### 背景

- 「別の番号だけ言及している引用」（例: 603ページなのに600関連のみ）や、「説明がない引用」（例: 「その他 444 に関連すること。」）が混在する問題。

### 変更点の要約

- 抽出側（tools/wikipedia_ja.py）
  - 先頭の番号ラベル（例: 「(603)」）を一致判定に使わないようにして、誤採用を抑制。
  - 「その他 N に関連すること。」は内容ゼロとして、他候補がある場合は採用しない（最後の手段としてのみ許容）。
  - refresh 時に候補が0件になった場合、古いキャッシュを保持し続けないよう空リストで上書きできるように調整。
- 生成側（tools/generate_numbers.py）
  - オフライン生成でも効果が出るよう、Wikipedia『その他』の出力直前に「対象数字への言及が無いもの」を抑制。
  - 「その他 N に関連すること。」は他候補が無い場合のみ残す。

### 動作確認

- 全件（0..999）を `--wikipedia-sections --offline` で再生成。
- 内部リンクチェック: `tools/check_internal_links.py`（Scanned markdown files: 1005 / Missing links: 0）

---

## 追記（42 pins 復活・不要引用抑制・全件再生成）

### 背景

- 042 の pins（銀河ヒッチハイク・ガイド系）が外れている（キャッシュ側の再取得が必要）。
- 042 に「都道府県コード」「第42代大統領」「Wikipedia 冒頭の定型的な短い引用」が混ざっており不要。

### 変更点の要約

- 42 の Wikipedia セクションキャッシュを refresh して pins を復活させる運用を確認。
- 生成側（tools/generate_numbers.py）で Wikipedia『その他』の低価値引用を抑制。
  - 例: 都道府県コード（JIS X 0401 / ISO 3166-2:JP）、米国「第◯代大統領」等
  - 他に有意な候補がある場合は除外し、候補がそれしか無い場合のみ残す（最後の手段）。
- Wikipedia 冒頭の「短い引用」は、『その他』が空のときのみ追加（冗長化を避ける）。

### 動作確認

- 42 のみ refresh を伴う再生成で pins が復活し、不要 3 引用が出ないことを確認。
- 全件（0..999）を `--wikipedia-sections` で再生成（refresh なし＝キャッシュ優先、必要時のみネットワーク取得）。
- 内部リンクチェック: `tools/check_internal_links.py`（Scanned markdown files: 1006 / Missing links: 0）
